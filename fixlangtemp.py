#!/usr/bin/env python3
import pywikibot
import toolforge
import re

# إعدادات البوت
class settings:
    lang = 'arwiki'
    editsumm = "[[وب:بوت|بوت]]: صيانة قوالب اللغة."
    debug = "no"  # لتجربة بدون حفظ، اجعلها "yes"

# استعلام SQL لجلب المقالات ضمن تصنيف "صيانة قوالب لغة"
query = '''
SELECT page.page_title
FROM page
JOIN categorylinks ON categorylinks.cl_from = page.page_id
WHERE categorylinks.cl_to = 'صيانة_قوالب_لغة'
AND page.page_namespace = 0
LIMIT 1000;
'''

# التعبيرات المنتظمة للقوالب ذات الوسيط الواحد
# r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*نص\s*\}\}': r'[[اللغة ال|ال]]',
lang_templates = {
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*عربية\s*\}\}': r'[[اللغة العربية|العربية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*إنجليزية\s*\}\}': r'[[اللغة الإنجليزية|الإنجليزية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*إنكليزية\s*\}\}': r'[[اللغة الإنجليزية|الإنجليزية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*انكليزية\s*\}\}': r'[[اللغة الإنجليزية|الإنجليزية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*بولندية\s*\}\}': r'[[اللغة البولندية|البولندية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*فينيقية\s*\}\}': r'[[اللغة الفينيقية|الفينيقية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*لتوانية\s*\}\}': r'[[اللغة اللتوانية|اللتوانية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*لاتفية\s*\}\}': r'[[اللغة اللاتفية|اللاتفية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*تشيكية\s*\}\}': r'[[اللغة التشيكية|التشيكية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*مجرية\s*\}\}': r'[[اللغة المجرية|المجرية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*رومانية\s*\}\}': r'[[اللغة الرومانية|الرومانية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*إسبانية\s*\}\}': r'[[اللغة الإسبانية|الإسبانية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*صربية\s*\}\}': r'[[اللغة الصربية|الصربية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*تركية\s*\}\}': r'[[اللغة التركية|التركية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*فارسية\s*\}\}': r'[[اللغة الفارسية|الفارسية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*إندونيسية\s*\}\}': r'[[اللغة الإندونيسية|الإندونيسية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*ويلزية\s*\}\}': r'[[اللغة الويلزية|الويلزية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*برتغالية\s*\}\}': r'[[اللغة البرتغالية|البرتغالية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*دانمركية\s*\}\}': r'[[اللغة الدانمركية|الدانمركية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*كورية\s*\}\}': r'[[اللغة الكورية|الكورية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*عبرية\s*\}\}': r'[[اللغة العبرية|العبرية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*سريانية\s*\}\}': r'[[اللغة السريانية|السريانية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*يابانية\s*\}\}': r'[[اللغة اليابانية|اليابانية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*سنسكريتية\s*\}\}': r'[[اللغة السنسكريتية|السنسكريتية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*جاوية\s*\}\}': r'[[اللغة الجاوية|الجاوية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*أوكرانية\s*\}\}': r'[[اللغة الأوكرانية|الأوكرانية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*انجليزية\s*\}\}': r'[[اللغة الإنجليزية|الإنجليزية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*هولندية\s*\}\}': r'[[اللغة الهولندية|الهولندية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*إغريقية\s*\}\}': r'[[اللغة الإغريقية|الإغريقية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*إثيوبية\s*\}\}': r'[[اللغة الأمهرية|الأمهرية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*أيمرية\s*\}\}': r'[[اللغة الأيمرية|الأيمرية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*سلوفينية\s*\}\}': r'[[اللغة السلوفينية|السلوفينية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*تترية\s*\}\}': r'[[اللغة التتارية|التتارية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*أكرانية\s*\}\}': r'[[اللغة الأوكرانية|الأوكرانية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*عثمانية\s*\}\}': r'[[اللغة التركية العثمانية|التركية العثمانية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*كتالونية\s*\}\}': r'[[اللغة الكتالونية|الكتالونية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*أذرية\s*\}\}': r'[[اللغة الأذرية|الأذرية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*أراغونية\s*\}\}': r'[[اللغة الأراغونية|الأراغونية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*لاتينية\s*\}\}': r'[[اللغة اللاتينية|اللاتينية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*نرويجية\s*\}\}': r'[[اللغة النرويجية|النرويجية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*مالطية\s*\}\}': r'[[اللغة المالطية|المالطية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*روسية\s*\}\}': r'[[اللغة الروسية|الروسية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*فرنسية\s*\}\}': r'[[اللغة الفرنسية|الفرنسية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*ألمانية\s*\}\}': r'[[اللغة الألمانية|الألمانية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*سويدية\s*\}\}': r'[[اللغة السويدية|السويدية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*يونانية\s*\}\}': r'[[اللغة اليونانية|اليونانية]]',
    r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*إيطالية\s*\}\}': r'[[اللغة الإيطالية|الإيطالية]]'
}

# تجميع كل الأنماط في تعبير واحد
compiled_lang_templates = [
    (re.compile(pattern, re.IGNORECASE), replacement) 
    for pattern, replacement in lang_templates.items()
]

def execute_query():
    """تنفيذ الاستعلام لاسترداد عناوين المقالات."""
    try:
        conn = toolforge.connect(settings.lang, 'analytics')
        with conn.cursor() as cursor:
            cursor.execute(query)
            results = cursor.fetchall()
        conn.close()
        return results
    except Exception as e:
        print("خطأ في تنفيذ الاستعلام:", e)
        return []

def fix_lang_templates(text):
    """استبدال قوالب وصلة لغة بروابط ويكي أو قالب اللغة."""
    new_text = text

    # استبدال {{وصلة لغة|xx|title}} أو {{لغ|xx|title}} بـ ({{اللغة|xx|title}})
    new_text = re.sub(
        r'\{\{\s*(?:وصلة\s*لغة|لغ)\s*\|\s*([\w\-]+)\s*\|\s*([^\|\}]+?)\s*\}\}',
        r'({{اللغة|\1|\2}})',
        new_text,
        flags=re.IGNORECASE
    )

    # استبدال القوالب ذات الوسيط الواحد حسب القائمة
    for regex, repl in compiled_lang_templates:
        new_text = regex.sub(repl, new_text)

    return new_text.strip()

def process_page(title, site):
    """تحديث صفحة واحدة إذا احتاجت تعديل."""
    page = pywikibot.Page(site, title)
    
    if not page.exists():
        return

    old_text = page.text
    new_text = fix_lang_templates(old_text)

    if old_text != new_text:
        if settings.debug == "no":
            page.text = new_text
            page.save(summary=settings.editsumm)
        else:
            print(f"تجربة فقط: {title}")
            print(new_text)

def main():
    site = pywikibot.Site('ar', 'wikipedia')
    results = execute_query()

    for row in results:
        title = row[0].decode('utf-8') if isinstance(row[0], bytes) else row[0]
        title = title.replace("_", " ")
        process_page(title, site)

if __name__ == "__main__":
    main()
